#!/usr/bin/env bash

OUT="$HOME/FineTuningAI/AI_INVENTORY.md"

echo "# AI System Inventory" > "$OUT"
echo "Generated: $(date)" >> "$OUT"
echo >> "$OUT"

echo "## Project State (FineTuningAI)" >> "$OUT"
echo >> "$OUT"

echo "- Repo path: $HOME/FineTuningAI" >> "$OUT"

echo -n "- Git remote origin: " >> "$OUT"
git -C "$HOME/FineTuningAI" remote get-url origin 2>/dev/null >> "$OUT" || echo "NOT SET" >> "$OUT"

echo -n "- Branch: " >> "$OUT"
git -C "$HOME/FineTuningAI" rev-parse --abbrev-ref HEAD 2>/dev/null >> "$OUT" || echo "UNKNOWN" >> "$OUT"

echo -n "- Head commit: " >> "$OUT"
git -C "$HOME/FineTuningAI" log -1 --pretty=format:"%h %ad %s" --date=iso 2>/dev/null >> "$OUT" || echo "NONE" >> "$OUT"
echo >> "$OUT"

echo "- Working tree changes: $(git -C "$HOME/FineTuningAI" status --porcelain 2>/dev/null | wc -l) item(s)" >> "$OUT"
echo >> "$OUT"

echo "  Changed files (git status --porcelain):" >> "$OUT"
git -C "$HOME/FineTuningAI" status --porcelain 2>/dev/null | sed 's/^/  - /' >> "$OUT" || true
echo >> "$OUT"

echo "## Project Identity" >> "$OUT"
echo >> "$OUT"
echo "- This is the FineTuningAI research platform." >> "$OUT"
echo "- Primary purpose: AI-assisted historical, theological, and corpus research." >> "$OUT"
echo "- GitHub-backed, version-controlled system." >> "$OUT"
echo "- Inventory file is the authoritative context rehydration document." >> "$OUT"
echo >> "$OUT"

echo "## Development Guardrails" >> "$OUT"
echo >> "$OUT"
echo "- GitHub repo is the source of truth." >> "$OUT"
echo "- Always run 'git status' before modifying scripts." >> "$OUT"
echo "- Commit and push after structural or architectural changes." >> "$OUT"
echo "- Never overwrite working scripts without versioning." >> "$OUT"
echo "- Bookshelf must be launched via: bin/bookshelf_launch." >> "$OUT"
echo "- PDFs = reading UI; TXTs = AI ingestion corpus." >> "$OUT"
echo "- Corpus flow: ingest → index → query (ask_corpus.py)." >> "$OUT"
echo >> "$OUT"

echo "## Bookshelf Wiring" >> "$OUT"
echo >> "$OUT"

echo "- Desktop file: $HOME/Desktop/Bookshelf.desktop" >> "$OUT"

echo "- Desktop Exec line:" >> "$OUT"
grep "^Exec=" "$HOME/Desktop/Bookshelf.desktop" 2>/dev/null >> "$OUT" || echo "NOT FOUND" >> "$OUT"

echo >> "$OUT"
echo "- Launcher present:" >> "$OUT"
[ -f "$HOME/FineTuningAI/bin/bookshelf_launch" ] && echo "yes" >> "$OUT" || echo "no" >> "$OUT"

echo "- Server .py size:" >> "$OUT"
ls -lh "$HOME/FineTuningAI/bin/bookshelf_server.py" 2>/dev/null >> "$OUT" || echo "MISSING" >> "$OUT"

echo "- Fallback .pyc present:" >> "$OUT"
[ -f "$HOME/FineTuningAI/bin/__pycache__/bookshelf_server.cpython-312.pyc" ] && echo "yes" >> "$OUT" || echo "no" >> "$OUT"

echo "- URL: http://127.0.0.1:8787" >> "$OUT"
echo >> "$OUT"

echo "## Host / OS" >> "$OUT"
uname -a >> "$OUT"
echo >> "$OUT"

echo "## Disk / Mounts" >> "$OUT"
df -h >> "$OUT"
echo >> "$OUT"

echo "## Block Devices (lsblk)" >> "$OUT"
lsblk -o NAME,SIZE,MODEL,SERIAL,TRAN,FSTYPE,FSVER,LABEL,UUID,MOUNTPOINTS >> "$OUT" 2>/dev/null || true
echo >> "$OUT"

echo "## Filesystem Signatures (blkid)" >> "$OUT"
if sudo -n true 2>/dev/null; then
  sudo blkid | grep -v '^/dev/loop' >> "$OUT" 2>/dev/null || true
else
  echo "(skipped: requires sudo; run 'sudo -v' first if you want this included)" >> "$OUT"
fi
echo >> "$OUT"

echo "## GPU" >> "$OUT"
command -v nvidia-smi >/dev/null && nvidia-smi >> "$OUT" || echo "No NVIDIA GPU detected" >> "$OUT"
echo >> "$OUT"

echo "## Python" >> "$OUT"
python3 --version >> "$OUT" 2>&1
pip3 --version >> "$OUT" 2>&1
echo >> "$OUT"

echo "## Virtual Environments" >> "$OUT"
find "$HOME" -type d -name "*venv*" 2>/dev/null >> "$OUT"
echo >> "$OUT"

echo "## Ollama Models" >> "$OUT"
command -v ollama >/dev/null && ollama list >> "$OUT" || echo "Ollama not installed" >> "$OUT"
echo >> "$OUT"

echo "- Ollama default model (if any):" >> "$OUT"
ollama list | head -n 2 >> "$OUT" 2>/dev/null || true
echo >> "$OUT"

echo "## AI Corpus" >> "$OUT"
if [ -d "$HOME/ai_corpus" ]; then
  du -sh "$HOME/ai_corpus" >> "$OUT"
  echo "- File count:" >> "$OUT"
  find "$HOME/ai_corpus" -type f | wc -l >> "$OUT"
else
  echo "ai_corpus directory not found" >> "$OUT"
fi
echo >> "$OUT"

echo "Inventory written to $OUT"
