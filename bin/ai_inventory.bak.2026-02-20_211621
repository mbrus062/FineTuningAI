#!/usr/bin/env bash

OUT="$HOME/FineTuningAI/AI_INVENTORY.md"

echo "# AI System Inventory" > "$OUT"
echo "Generated: $(date)" >> "$OUT"
echo >> "$OUT"

echo "## Project State (FineTuningAI)" >> "$OUT"
echo >> "$OUT"

echo "- Repo path: $HOME/FineTuningAI" >> "$OUT"

echo -n "- Git remote origin: " >> "$OUT"
git -C "$HOME/FineTuningAI" remote get-url origin 2>/dev/null >> "$OUT" || echo "NOT SET" >> "$OUT"

echo -n "- Branch: " >> "$OUT"
git -C "$HOME/FineTuningAI" rev-parse --abbrev-ref HEAD 2>/dev/null >> "$OUT" || echo "UNKNOWN" >> "$OUT"

echo -n "- Head commit: " >> "$OUT"
git -C "$HOME/FineTuningAI" log -1 --pretty=format:"%h %ad %s" --date=iso 2>/dev/null >> "$OUT" || echo "NONE" >> "$OUT"
echo >> "$OUT"

echo "- Working tree changes: $(git -C "$HOME/FineTuningAI" status --porcelain 2>/dev/null | wc -l) item(s)" >> "$OUT"
echo >> "$OUT"

echo "  Changed files (git status --porcelain):" >> "$OUT"
git -C "$HOME/FineTuningAI" status --porcelain 2>/dev/null | sed 's/^/  - /' >> "$OUT" || true
echo >> "$OUT"

echo "## Project Identity" >> "$OUT"
echo >> "$OUT"
echo "- This is the FineTuningAI research platform." >> "$OUT"
echo "- Primary purpose: AI-assisted historical, theological, and corpus research." >> "$OUT"
echo "- GitHub-backed, version-controlled system." >> "$OUT"
echo "- Inventory file is the authoritative context rehydration document." >> "$OUT"
echo >> "$OUT"

echo "## Development Guardrails" >> "$OUT"
echo >> "$OUT"
echo "- GitHub repo is the source of truth." >> "$OUT"
echo "- Always run 'git status' before modifying scripts." >> "$OUT"
echo "- Commit and push after structural or architectural changes." >> "$OUT"
echo "- Never overwrite working scripts without versioning." >> "$OUT"
echo "- Bookshelf must be launched via: bin/bookshelf_launch." >> "$OUT"
echo "- PDFs = reading UI; TXTs = AI ingestion corpus." >> "$OUT"
echo "- Corpus flow: ingest → index → query (ask_corpus.py)." >> "$OUT"
echo >> "$OUT"

echo "## Bookshelf Wiring" >> "$OUT"
echo >> "$OUT"

echo
echo "## Library Roots (Bookshelf vs Corpus)"

BOOKSHELF_SERVER="$HOME/FineTuningAI/bin/bookshelf_server.py"
if [ -f "$BOOKSHELF_SERVER" ]; then
  LIBROOT=$(python3 - <<'PY'
import re, pathlib
p = pathlib.Path.home()/"FineTuningAI/bin/bookshelf_server.py"
txt = p.read_text(encoding="utf-8", errors="ignore")
m = re.search(r'LIBRARY_ROOT\s*=\s*os\.path\.expanduser\("([^"]+)"\)', txt)
print(m.group(1) if m else "")
PY
)
  if [ -n "$LIBROOT" ]; then
    LIBROOT_EXPANDED=$(python3 - <<PY
import os
print(os.path.expanduser("$LIBROOT"))
PY
)
    echo "- Bookshelf LIBRARY_ROOT: $LIBROOT_EXPANDED"
    echo "- Bookshelf LIBRARY_ROOT realpath: $(realpath "$LIBROOT_EXPANDED" 2>/dev/null || echo "n/a")"
    echo "- Bookshelf LIBRARY_ROOT size: $(du -sh "$LIBROOT_EXPANDED" 2>/dev/null | awk '{print $1}' || echo "n/a")"
    echo "- Bookshelf PDF count: $(find "$LIBROOT_EXPANDED" -type f -iname "*.pdf" 2>/dev/null | wc -l)"
    echo "- Bookshelf TXT count: $(find "$LIBROOT_EXPANDED" -type f -iname "*.txt" 2>/dev/null | wc -l)"
  fi
fi

# Likely corpus roots (additive; doesn't move anything)
CANDIDATES=(
  "/ai_data/ai_corpus"
  "/ai_data/ebooks"
  "/ai_data/extracted_text"
  "/ai_data/index"
  "/ai_data/index_egw"
  "/ai_data/index_egw_complete"
  "/ai_data/index_harvard"
  "$HOME/ai_corpus"
)

for d in "${CANDIDATES[@]}"; do
  if [ -d "$d" ]; then
    echo
    echo "- Corpus candidate: $d"
    echo "  - realpath: $(realpath "$d" 2>/dev/null || echo "n/a")"
    echo "  - size: $(du -sh "$d" 2>/dev/null | awk '{print $1}' || echo "n/a")"
    echo "  - pdf: $(find "$d" -type f -iname '*.pdf' 2>/dev/null | wc -l)"
    echo "  - txt: $(find "$d" -type f -iname '*.txt' 2>/dev/null | wc -l)"
    echo "  - top dirs: $(ls -1 "$d" 2>/dev/null | head -n 8 | tr '\n' ' ' )"
  fi
done

# Manifest db (if present)
for mf in "/ai_data/manifest.sqlite" "$HOME/ai_corpus/manifest.sqlite"; do
  if [ -f "$mf" ]; then
    echo
    echo "- Manifest DB: $mf"
    ls -lh "$mf" | awk '{print "  - size:", $5, "modified:", $6, $7, $8}'
  fi
done

echo "- Desktop file: $HOME/Desktop/Bookshelf.desktop" >> "$OUT"

echo "- Desktop Exec line:" >> "$OUT"
grep "^Exec=" "$HOME/Desktop/Bookshelf.desktop" 2>/dev/null >> "$OUT" || echo "NOT FOUND" >> "$OUT"

echo >> "$OUT"
echo "- Launcher present:" >> "$OUT"
[ -f "$HOME/FineTuningAI/bin/bookshelf_launch" ] && echo "yes" >> "$OUT" || echo "no" >> "$OUT"

echo "- Server .py size:" >> "$OUT"
ls -lh "$HOME/FineTuningAI/bin/bookshelf_server.py" 2>/dev/null >> "$OUT" || echo "MISSING" >> "$OUT"

echo "- Fallback .pyc present:" >> "$OUT"
[ -f "$HOME/FineTuningAI/bin/__pycache__/bookshelf_server.cpython-312.pyc" ] && echo "yes" >> "$OUT" || echo "no" >> "$OUT"

echo "- URL: http://127.0.0.1:8787" >> "$OUT"
echo >> "$OUT"

echo "## Host / OS" >> "$OUT"
uname -a >> "$OUT"
echo >> "$OUT"

echo "## Disk / Mounts" >> "$OUT"
df -h >> "$OUT"
echo >> "$OUT"

echo "## Block Devices (lsblk)" >> "$OUT"
lsblk -o NAME,SIZE,MODEL,SERIAL,TRAN,FSTYPE,FSVER,LABEL,UUID,MOUNTPOINTS >> "$OUT" 2>/dev/null || true
echo >> "$OUT"

echo "## Filesystem Signatures (blkid)" >> "$OUT"
if sudo -n true 2>/dev/null; then
  sudo blkid | grep -v '^/dev/loop' >> "$OUT" 2>/dev/null || true
else
  echo "(skipped: requires sudo; run 'sudo -v' first if you want this included)" >> "$OUT"
fi
echo >> "$OUT"

echo "## GPU" >> "$OUT"
command -v nvidia-smi >/dev/null && nvidia-smi >> "$OUT" || echo "No NVIDIA GPU detected" >> "$OUT"
echo >> "$OUT"

echo "## Python" >> "$OUT"
python3 --version >> "$OUT" 2>&1
pip3 --version >> "$OUT" 2>&1
echo >> "$OUT"

echo "## Virtual Environments" >> "$OUT"
find "$HOME" -type d -name "*venv*" 2>/dev/null >> "$OUT"
echo >> "$OUT"

echo "## Ollama Models" >> "$OUT"
command -v ollama >/dev/null && ollama list >> "$OUT" || echo "Ollama not installed" >> "$OUT"
echo >> "$OUT"

echo "- Ollama default model (if any):" >> "$OUT"
ollama list | head -n 2 >> "$OUT" 2>/dev/null || true
echo >> "$OUT"

echo "## AI Corpus" >> "$OUT"
if [ -d "$HOME/ai_corpus" ]; then
  du -sh "$HOME/ai_corpus" >> "$OUT"
  echo "- File count:" >> "$OUT"
  find "$HOME/ai_corpus" -type f | wc -l >> "$OUT"
else
  echo "ai_corpus directory not found" >> "$OUT"
fi
echo >> "$OUT"

echo "Inventory written to $OUT"
